import time


class RemoteShell:
    def __init__(self, shell):
        self.sudo = False
        self.shell = shell

    def execute_cmd(self, cmd):
        self.shell.send(cmd + "\n")
        out = str(self.shell.recv(9999).decode())
        if cmd[:4] == "sudo":
            self.sudo = True
            while "password" not in out.lower():
                last_line = out.split("\n")[-1]
                if "$" in last_line or "#" in last_line:
                    if self.sudo:
                        self.sudo = False
                    out = out.replace(cmd, "")
                    break
                time.sleep(0.5)
                out = out + str(self.shell.recv(9999).decode())
        else:
            last_line = ""
            while True:
                last_line = out.split("\n")[-1]
                if not self.sudo:
                    if (
                        "@" in last_line and ("$" in last_line or "#" in last_line)
                    ) or (
                        "bash" in last_line and ("$" in last_line or "#" in last_line)
                    ):
                        out = out.replace(cmd, "")
                        break
                else:
                    if "password" in last_line:
                        break
                    if "@" in last_line and ("$" in last_line or "#" in last_line):
                        self.sudo = False
                        break

                time.sleep(0.5)
                out = out + str(self.shell.recv(9999).decode())

        return out
