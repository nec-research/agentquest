from pydantic import Field

from .base_tool import BaseTool


class LocalCommand(BaseTool):
    """Execute a bash command on the Kali machine.
    Note: you cannot use 'ssh'. Use ConnectRemote instead."""

    cmd: str = Field(..., description="The bash command", title="cmd")

    def _execute_remote_command(self, ssh):
        if "ssh" in self.cmd and "@" in self.cmd:
            return "Never use the ssh command. Use the ConnectRemote tool."
        try:
            stdin, stdout, stderr = ssh.exec_command(self.cmd)
            output = []
            # Read and print stdout and stderr line by line in real-time
            for line in iter(stdout.readline, ""):
                output.append(line.strip())
            for line in iter(stderr.readline, ""):
                output.append(line.strip())
            output = "\n".join(output)

            return output

        except Exception as e:
            return f"Error executing remote command: {e}"

    def run(self, ssh):
        return self._execute_remote_command(ssh)
